<Page
    x:Class="NeoCardium.Views.PracticePage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:vm="using:NeoCardium.ViewModels"
    mc:Ignorable="d"
    x:Name="PracticePageView"
    Background="{ThemeResource PracticePageBackgroundBrush}"
    Padding="20">

    <Grid>
        <!-- Grid Rows:
             Row 0: Top Bar (progress and Tamagotchi button)
             Row 1: Category & Mode Selection (visible if no session)
             Row 2: Practice Area (visible if session active)
             Row 3: Start/Cancel Button
             Final Stats overlay spans all rows when visible -->
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- ROW 0: TOP BAR -->
        <Grid Grid.Row="0" Margin="0,0,0,10">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>
            <!-- Optional progress info can be placed here if desired -->

            <!-- Tamagotchi Button -->
            <Button x:Name="TamagotchiButton"
                    Grid.Column="1"
                    Width="60" Height="60"
                    CornerRadius="30"
                    Background="#33FFFFFF"
                    HorizontalAlignment="Right"
                    Click="TamagotchiButton_Click">
                <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                    <SymbolIcon Symbol="Emoji"/>
                    <TextBlock Text="Pet" FontSize="10" HorizontalAlignment="Center"/>
                </StackPanel>
            </Button>
        </Grid>

        <!-- ROW 1: CATEGORY & MODE SELECTION -->
        <StackPanel Grid.Row="1"
                    Orientation="Vertical"
                    HorizontalAlignment="Center"
                    VerticalAlignment="Center"
                    Spacing="15"
                    Visibility="{Binding IsCategorySelectionVisible, Converter={StaticResource BooleanToVisibilityConverter}}">
            <ComboBox Width="300"
                      ItemsSource="{Binding Categories}"
                      SelectedItem="{Binding SelectedCategory, Mode=TwoWay}"
                      DisplayMemberPath="CategoryName"
                      PlaceholderText="Kategorie wÃ¤hlen"
                      HorizontalAlignment="Center"/>
            <ComboBox Width="300"
                      ItemsSource="{Binding AvailableModes}"
                      SelectedItem="{Binding SelectedModeOption, Mode=TwoWay}"
                      DisplayMemberPath="ModeName"
                      PlaceholderText="Lernmodus wÃ¤hlen"
                      HorizontalAlignment="Center"/>
        </StackPanel>

        <!-- ROW 2: PRACTICE AREA -->
        <Grid Grid.Row="1" Margin="20"
              Visibility="{Binding IsSessionActive, Converter={StaticResource BooleanToVisibilityConverter}}"
              HorizontalAlignment="Center">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <!-- Question Card -->
                <RowDefinition Height="Auto"/>
                <!-- Feedback -->
                <RowDefinition Height="*"/>
                <!-- Answer Options -->
            </Grid.RowDefinitions>
            <!-- Question Card -->
            <Border Grid.Row="0"
                    Style="{StaticResource PracticeCardStyle}"
                    Margin="0,0,0,20"
                    MaxWidth="600">
                <TextBlock Text="{Binding CurrentQuestion.Question}"
                           FontSize="24"
                           FontWeight="Bold"
                           Foreground="White"
                           TextWrapping="Wrap"
                           TextAlignment="Center"
                           HorizontalAlignment="Center"
                           VerticalAlignment="Center"/>
            </Border>
            <!-- Feedback Message -->
            <TextBlock Grid.Row="1"
                       Text="{Binding FeedbackMessage}"
                       FontSize="20"
                       Foreground="White"
                       TextAlignment="Center"
                       HorizontalAlignment="Center"
                       VerticalAlignment="Center"
                       Visibility="{Binding IsFeedbackVisible, Converter={StaticResource BooleanToVisibilityConverter}}"/>
            <!-- Answer Options -->
            <Grid Grid.Row="2">
                <!-- Multiple-Choice Mode -->
                <StackPanel HorizontalAlignment="Center"
            Visibility="{Binding SelectedMode, Converter={StaticResource EnumToVisibilityConverter}, ConverterParameter=MultipleChoice}">
                    <ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
                        <ItemsControl ItemsSource="{Binding AnswerOptions}">
                            <!-- 1) Use ItemsWrapGrid or WrapGrid, not VariableSizedWrapGrid -->
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <ItemsWrapGrid Orientation="Horizontal"
                                   HorizontalAlignment="Center"
                                   MaximumRowsOrColumns="2"/>
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>

                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <!-- 2) Remove Height/MaxHeight, let it auto-size. -->
                                    <Button Command="{Binding DataContext.CheckAnswerAsync, ElementName=PracticePageView}"
                                            CommandParameter="{Binding}"
                                            Style="{StaticResource AnswerButtonStyle}"
                                            HorizontalAlignment="Stretch"
                                            VerticalAlignment="Top"
                                            MinWidth="200"
                                            MinHeight="50"
                                            Margin="10">
                                        <!-- 3) Use a TextBlock with TextWrapping="Wrap" -->
                                        <TextBlock Text="{Binding AnswerText}"
                                                   TextWrapping="Wrap"
                                                   TextAlignment="Center"
                                                   VerticalAlignment="Top"
                                                   HorizontalAlignment="Center"/>
                                    </Button>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>
                </StackPanel>

                <!-- Flashcard Mode -->
                <StackPanel HorizontalAlignment="Center"
                            Visibility="{Binding SelectedMode, Converter={StaticResource EnumToVisibilityConverter}, ConverterParameter=Flashcard}">
                    <Button Content="{Binding AnswerButtonText}"
                            Command="{Binding RevealAnswerCommand}"
                            Padding="15,5"
                            FontSize="18"
                            Width="250"
                            HorizontalAlignment="Center"
                            Margin="20"
                            IsEnabled="{Binding IsNotProcessing}"
                            Style="{StaticResource AnswerButtonStyle}"/>
                    <Border Style="{StaticResource PracticeCardStyle}"
                            Margin="20,10,20,0"
                            Visibility="{Binding IsAnswerRevealed, Converter={StaticResource BooleanToVisibilityConverter}}">
                        <TextBlock Text="{Binding CurrentQuestion.Answer}"
                                   FontSize="22"
                                   FontWeight="Bold"
                                   Foreground="White"
                                   TextWrapping="Wrap"
                                   TextAlignment="Center"
                                   HorizontalAlignment="Center"/>
                    </Border>
                </StackPanel>
            </Grid>
        </Grid>

        <!-- ROW 3: START/ABBRECHEN BUTTON -->
        <Button Grid.Row="3"
                HorizontalAlignment="Center"
                Content="{Binding IsSessionActive, Converter={StaticResource BooleanToStartCancelConverter}}"
                Command="{Binding TogglePracticeSessionCommand}"
                Visibility="{Binding IsFinalStatisticsVisible, Converter={StaticResource BooleanInverterConverter}}"
                Margin="10"
                Padding="15,5"
                FontSize="18"
                Width="150"/>

        <!-- FINAL STATISTICS OVERLAY (spans all rows) -->
        <Border Grid.RowSpan="4"
                Style="{StaticResource PracticeCardStyle}"
                Padding="20"
                Width="350"
                Visibility="{Binding IsFinalStatisticsVisible, Converter={StaticResource BooleanToVisibilityConverter}}"
                HorizontalAlignment="Center"
                VerticalAlignment="Center"
                BorderThickness="1">
            <StackPanel HorizontalAlignment="Center" Spacing="15">
                <TextBlock Text="ðŸ“ Deine Lernstatistik"
                           FontSize="20"
                           FontWeight="Bold"
                           Foreground="White"
                           HorizontalAlignment="Center"/>
                <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                    <TextBlock Text="âœ… Richtige Antworten:" Foreground="LightGreen" FontSize="18"/>
                    <TextBlock Text="{Binding TotalCorrect}" Foreground="LightGreen" FontSize="18" FontWeight="Bold" Margin="5,0,0,0"/>
                </StackPanel>
                <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                    <TextBlock Text="âŒ Falsche Antworten:" Foreground="OrangeRed" FontSize="18"/>
                    <TextBlock Text="{Binding TotalIncorrect}" Foreground="OrangeRed" FontSize="18" FontWeight="Bold" Margin="5,0,0,0"/>
                </StackPanel>
                <ProgressBar Minimum="0"
                             Maximum="{Binding TotalAnswered}"
                             Value="{Binding TotalCorrect}"
                             Width="250"
                             Foreground="LightBlue"
                             CornerRadius="5"
                             HorizontalAlignment="Center"/>
                <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" Spacing="10">
                    <Button Content="ðŸ”„ Erneut Ã¼ben"
                            Command="{Binding RestartSessionCommand}"
                            Style="{StaticResource AccentButtonStyle}"/>
                    <Button Content="ðŸ›‘ Beenden"
                            Command="{Binding CloseSessionCommand}"
                            Background="HotPink"
                            Foreground="White"
                            CornerRadius="8"/>
                </StackPanel>
            </StackPanel>
        </Border>

    </Grid>
</Page>
